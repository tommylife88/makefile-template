# makefile-template

Makefileって作るときはいろいろ調べながら作るけど、一度作るとそれ以上触ることないので、よく忘れる。備忘録も兼ねてテンプレとして残しておきます。

## ポイント

### out-of-source ビルド

本Makefileはout-of-sourceビルドとしています。buildディレクトリ直下に実行ファイル、build/objディレクトリにオブジェクトファイルと依存関係リストファイルを生成しています。
out-of-source ビルドする利点として、

* ソースディレクトリが汚れない
* cleanするときに楽

があります。

### ヘッダファイルの依存関係の解決（-MMD、-MPオプション）

Makefileの依存関係の記述の仕方によっては、ヘッダーファイルのみを編集した場合で、そのヘッダーファイルをインクルードしているソースファイルがコンパイルされないことがあります。しかもたちが悪いことにビルドが通ってしまう可能性もあるため致命的な欠陥になりかねないのです。

これは-MMDや-MPオプションで解決できます。

* -MMD … 依存関係にあるファイルリストを拡張子.dのファイルに保存しコンパイルを行う。
* -MP … ヘッダーファイルを削除した場合、もともと依存関係にあるファイルはそのヘッダーファイルを探してしまいコンパイルが通らなくなる。本オプションは偽のターゲットを定義することで、削除されたはずのヘッダーファイルを探しても大丈夫なようにしてあげる。

```makefile
（省略）
SRCS := $(shell find $(SRCDIR) -name *.cpp -or -name *.c -or -name *.s)
OBJS := $(SRCS:%=$(OBJDIR)/%.o)
DEPS := $(OBJS:.o=.d)
（省略）
CPPFLAGS := $(INCLUDE) -MMD -MP
（省略）
-include $(DEPS)
（省略）
```

本MakefileではDEPS変数に全オブジェクトファイルの依存ファイルである拡張子.dファイルを生成し、-include $(DEPS)で依存関係の解消を行っています。
